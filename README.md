# Python Telegram Bot Starter Kit [![CI](https://github.com/andrewscwei/python-telegram-bot-starter-kit/workflows/CI/badge.svg)](https://github.com/andrewscwei/python-telegram-bot-starter-kit/actions/workflows/ci.yml) [![CD](https://github.com/andrewscwei/python-telegram-bot-starter-kit/workflows/CD/badge.svg)](https://github.com/andrewscwei/python-telegram-bot-starter-kit/actions/workflows/cd.yml)

This is a webhook-based Telegram bot that uses the following:
- [Flask](https://flask.palletsprojects.com)
- [`python-telegram-bot`](https://github.com/python-telegram-bot/python-telegram-bot)
- [PostgreSQL](https://www.postgresql.org/) managed by [`flask-sqlalchemy`](https://flask-sqlalchemy.palletsprojects.com/en/2.x/)
- [Heroku Container Registry](https://www.heroku.com/deploy-with-docker)

## Usage

### Prerequisites

To begin development you just need to ensure that the following are installed in your local machine:
- [Docker](https://www.docker.com/)
- [`ngrok`](https://ngrok.com/download): Optional, but required in order to test the bot locally from Telegram

To build the project directly, ensure the following are installed:
- [`pyenv`](https://github.com/pyenv/pyenv): To easily switch between Python versions
- [`pipenv`](https://pipenv.pypa.io/en/latest/): To manage `pip` dependencies and virtual environments

### Environment

Prepare `.env` file containing minimum environment variables for the bot:

```sh
# .env

BOT_TOKEN="<token>"
```

### Development

To run the bot locally in dev mode with file watching and live reload:

```sh
# Run the app locally on port 8080
$ make dev
```

### Production

To run the bot locally in production mode:

```sh
# Build the Docker image
$ make build

# Run the app locally on port 8080
$ make run
```

### Unit Tests

To run unit tests:

```sh
$ make test
```

### Testing Local Bot on Telegram

First, run [`ngrok`](https://ngrok.com/download) to expose the bot to the public, make note of the public URL:

```sh
$ ngrok http 8080
```

Next, set the webhook URL of the bot to the public URL generated by `ngrok`:

```sh
$ source .env
$ export PUBLIC_URL="<ngrok_url>"

$ curl https://api.telegram.org/bot$BOT_TOKEN/setWebhook?url=$PUBLIC_URL
```

You should now be able to communicate directly with your local bot from Telegram.
